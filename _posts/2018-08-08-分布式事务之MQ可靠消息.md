---
layout: post
title: "分布式事务之MQ可靠消息"
date: 2018-08-08
tags: java
---

使用MQ可靠消息能够解决分布式事务的**最终一致性，**但不是实时一致(强一致性)。所以使用时要注意应用场景。

MQ可靠消息：

1.预发消息：MQ发送消息之前把消息的信息先存到数据库中留底，设置一个字段状态为待确认。(作用：能够知道这条消息是否发送成功，可进行人工补偿)

2.进行业务操作

3.向MQ发送消息，发送成功后把预发消息的状态改为发送中(表示成功发送)，如果失败就不需要修改

应用场景：充值业务  订单->账务

充值成功后

第一步，将消息的信息先存到数据库中留底，设置一个字段状态为待确认(预发消息)

第二步，修改充值的订单状态为充值功能

第三步，发送MQ消息到账务系统，通知账务系统记录订单的账务明细



特殊MQ可靠消息保证事务的场景：用户短时间多笔消费  订单->账户扣款

如果消费时，先修改订单状态，再扣款。有10笔订单的消费状态都修成了成功，但是账户的余额不够钱扣除10笔订单。这样就会出问题了

解决的方案：用户消费时，先扣款再修改订单

不能使用MQ可靠消息保证事务的场景：交易完成后既要 **扣款** 也要 **减库存**。这种场场景要使用强一致性事务